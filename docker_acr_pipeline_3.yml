trigger: none

pool:
  name: "linuxpool"
  demands:
    - Agent.Name -equals linuxagent

variables:
  # Set the major version here. This remains static, and you only update the minor version.
  MajorVersion: '1'
  # Use the Build.Counter to auto-increment the minor version (e.g., 1.0, 1.1, 1.2, etc.)
  MinorVersion: $[counter(variables['Build.SourceBranchName'], 1)]
  # Construct the full version tag as `MajorVersion.MinorVersion`
  VersionTag: "$(MajorVersion).$(MinorVersion)"

stages:
- stage: Build_and_Push_DockerImage
  jobs:

  - job: CopyFiles
    displayName: "Copy Files From Default Location"
    steps:
    - task: CopyFiles@2
      inputs:
        SourceFolder: "/home/devopsdockeruser/vsts-agent/_work/1/s/"
        Contents: '**' 
        TargetFolder: "/home/devopsdockeruser/dotnet_code"
        
  - job: BuildAndPush
    displayName: "Build and Push Docker Image"
    steps:
    - task: Docker@2
      inputs:
        containerRegistry: 'devops-acr-connection'
        repository: 'prkapp'
        command: 'buildAndPush'
        Dockerfile: '/home/devopsdockeruser/dotnet_code/Dockerfile'
        buildContext: '/home/devopsdockeruser/dotnet_code/'
        tags: $(VersionTag)
        